//
// Copyright (C) 2025 愛子あゆみ <ayumi.aiko@outlook.com>
//
// This program is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.
//
// This program is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.
//
// You should have received a copy of the GNU General Public License
// along with this program.  If not, see <http://www.gnu.org/licenses/>.
//
#include <stdio.h>
#include <string.h>
#include <libgen.h>

// let's store differing bytes in a str array!
int arr[] = {0};

int stringByteCompare(const char *needle, const char *haystack) {
    size_t endStrIndexOfNeedle = strcspn(needle, "\0");
    size_t endStrIndexOfHaystack = strcspn(haystack, "\0");
    for(int i = 0; i < endStrIndexOfHaystack; i++) if(needle[i] != haystack[i]) return i;
    return -1;
}

int stringByteCompareAndStoreDiffering(const char *needle, const char *haystack, int *byteCount) {
    size_t lenNeedle = strlen(needle);
    size_t lenHaystack = strlen(haystack);
    size_t minLen = (lenNeedle < lenHaystack) ? lenNeedle : lenHaystack;
    for(size_t i = 0; i < minLen; i++) {
        (*byteCount)++;
        if((unsigned char)needle[i] != (unsigned char)haystack[i]) {
            arr[0] = (unsigned char)needle[i];
            arr[1] = (unsigned char)haystack[i];
            return i;
        }
    }
    if(lenNeedle != lenHaystack) {
        (*byteCount)++;
        arr[0] = (lenNeedle > lenHaystack) ? (unsigned char)needle[minLen] : 0;
        arr[1] = (lenHaystack > lenNeedle) ? (unsigned char)haystack[minLen] : 0;
        return (int)minLen;
    }
    return -1;
}

int main(const int argc, const char *argv[]) {
    if(argc >= 4 && (strcmp(argv[1], "-b") == 0 || strcmp(argv[1], "--print-bytes") == 0)) {
        char contentOfOne[1024];
        char contentOfTwo[1024];
        FILE *firstFile = fopen(argv[2], "r");
        FILE *secondFile = fopen(argv[3], "r");
        if(!firstFile) {
            printf("Failed to open %s: No such file or directory\n", argv[2]);
            return -1;
        }
        if(!secondFile) {
            fclose(firstFile);
            printf("Failed to open %s: No such file or directory\n", argv[3]);
            return -1;
        }
        contentOfOne[fread(contentOfOne, 1, sizeof(contentOfOne)-1, firstFile)] = '\0';
        contentOfTwo[fread(contentOfTwo, 1, sizeof(contentOfTwo)-1, secondFile)] = '\0';
        fclose(firstFile);
        fclose(secondFile);
        int byteCount = 0;
        // small hack to make the diffIndex output to be same as cmp.
        int diffIndex = stringByteCompareAndStoreDiffering(contentOfOne, contentOfTwo, &byteCount) + 1;
        if(diffIndex == -1) return 0;
        printf("%s %s differ: byte %d: '%c' vs '%c'\n", argv[2], argv[3], diffIndex, arr[0], arr[1]);
        return 1;
    }
    else if(argc >= 3) {
        char contentOfOne[1024];
        char contentOfTwo[1024];
        FILE *firstFile = fopen(argv[1], "r");
        FILE *secondFile = fopen(argv[2], "r");
        if(!firstFile) {
            printf("Failed to open %s: No such file or directory\n", argv[1]);
            return -1;
        }
        if(!secondFile) {
            fclose(firstFile);
            printf("Failed to open %s: No such file or directory\n", argv[2]);
            return -1;
        }
        contentOfOne[fread(contentOfOne, 1, sizeof(contentOfOne)-1, firstFile)] = '\0';
        contentOfTwo[fread(contentOfTwo, 1, sizeof(contentOfTwo)-1, secondFile)] = '\0';
        fclose(firstFile);
        fclose(secondFile);
        // small hack to make the diffIndex output to be same as cmp.
        int diffIndex = stringByteCompare(contentOfOne, contentOfTwo) + 1;
        if(diffIndex == -1) return 0;
        printf("%s %s differ: byte %d\n", argv[1], argv[2], diffIndex);
        return 1;
    }
    else if(strcmp(argv[1], "--help") == 0 || strcmp(argv[1], "-h") == 0) {
        printf("Usage: %s [OPTION]... [FILE1] [FILE2]\n", basename((char *)argv[0]));
        printf("Compare two files byte by byte.\n\n");
        printf("  -b, --print-bytes          print differing bytes\n");
        printf("  -h, --help        display this help and exit\n");
        printf("  -v, --version     output version information and exit\n");
        return 1;
    }
    else if(strcmp(argv[1], "--version") == 0 || strcmp(argv[1], "-v") == 0) { 
        printf("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣾⠓⠶⣤⠀⠀⠀⠀⣠⠶⣄⡀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢸⠇⠀⢠⡏⠀⠀⢀⡔⠉⠀⢈⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠩⠤⣄⣼⠁⠀⣠⠟⠀⠀⣠⠏⠀⠀⢀⣀⠀⠀⠀⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⢀⣀⣀⣀⣀⣀⣀⣀⠀⠀⠀⠁⠀⠀⠣⣤⣀⡼⠃⠀⢀⡴⠋⠈⠳⡄⠀⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣠⣴⣶⣿⡿⠿⠿⠟⠛⠛⠛⠛⠿⠿⣿⣿⣶⣤⣄⠀⠀⠀⠉⠀⢀⡴⠋⠀⠀⣠⠞⠁⠀⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⢀⣴⣾⣿⠿⠋⠉⢀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⠉⠻⢿⣿⣶⣄⠀⠀⠳⣄⠀⣠⠞⢁⡠⢶⡄⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣾⣿⠿⠋⠀⠀⢀⣴⠏⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠑⢤⡈⠛⢿⣿⣦⡀⠈⠛⢡⠚⠃⠀⠀⢹⡆⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠀⠀⠀⢀⣼⣿⠟⠁⠀⠀⠀⢀⣾⠃⠀⠀⢀⡀⠀⠀⠀⠀⠀⠀⠀⠀⢻⡆⠀⠀⢻⣦⠀⠙⢿⣿⣦⡀⠈⢶⣀⡴⠞⠋⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠀⠀⣠⣿⡿⠃⠀⠀⠀⠀⢀⣾⡇⢀⡄⠀⢸⡇⠀⠀⠀⠀⠀⠀⣀⠀⢸⣷⡀⠀⠀⠹⣷⡀⠀⠙⢿⣷⡀⠀⠉⠀⠀⠀⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠀⣰⣿⡟⠀⠀⠀⠀⠀⠀⣾⣿⠃⣼⡇⠀⢸⡇⠀⠀⠀⠀⠀⠀⣿⠀⢸⣿⣷⡀⠀⢀⣾⣿⡤⠐⠊⢻⣿⡀⠀⠀⠀⠀⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⢠⣿⣿⣼⡇⠀⠀⠀⠀⢠⣿⠉⢠⣿⠧⠀⣸⣇⣠⡄⠀⠀⠀⠀⣿⠠⢸⡟⠹⣿⡍⠉⣿⣿⣧⠀⠀⠀⠻⣿⣶⣄⠀⠀⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⢸⣿⣿⡟⠀⠀⠀⠀⠀⣼⡏⢠⡿⣿⣦⣤⣿⡿⣿⡇⠀⠀⠀⢸⡿⠻⣿⣧⣤⣼⣿⡄⢸⡿⣿⡇⠀⠀⢠⣌⠛⢿⣿⣶⣤⣤⣄⡀\n");
        printf("⠀⠀⠀⣀⣤⣿⣿⠟⣀⠀⠀⠀⠀⠀⣿⢃⣿⠇⢿⣯⣿⣿⣇⣿⠁⠀⠀⠀⣾⡇⢸⣿⠃⠉⠁⠸⣿⣼⡇⢻⡇⠀⠀⠀⢿⣷⣶⣬⣭⣿⣿⣿⠇\n");
        printf("⣾⣿⣿⣿⣿⣻⣥⣾⡇⠀⠀⠀⠀⠀⣿⣿⠇⠀⠘⠿⠋⠻⠿⠿⠶⠶⠾⠿⠿⠍⢛⣧⣰⠶⢀⣀⣼⣿⣴⡸⣿⠀⠀⠀⠸⣿⣿⣿⠉⠛⠉⠀⠀\n");
        printf("⠘⠛⠿⠿⢿⣿⠉⣿⠁⠀⠀⠀⠀⢀⣿⡿⣶⣶⣶⣤⣤⣤⣀⣀⠀⠀⠀⠀⠀⠀⢀⣭⣶⣿⡿⠟⠋⠉⠀⠀⣿⠀⡀⡀⠀⣿⣿⣿⡆⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⣼⣿⠀⣿⠀⠀⠸⠀⠀⠸⣿⠇⠀⠀⣈⣩⣭⣿⡿⠟⠃⠀⠀⠀⠀⠀⠙⠛⠛⠛⠛⠻⠿⠷⠆⠀⣯⠀⠇⡇⠀⣿⡏⣿⣧⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⢿⣿⡀⣿⡆⠀⠀⠀⠀⠀⣿⠰⠿⠿⠛⠋⠉⠀⠀⢀⣴⣶⣶⣶⣶⣶⣦⠀⠀⠀⠀⠀⠀⠀⠀⠀⢹⣧⠀⠀⠀⣿⡇⣿⣿⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⢸⣿⡇⢻⣇⠀⠘⣰⡀⠀⣿⠀⠀⠀⠀⠀⠀⠀⠀⢸⣿⠀⠀⠀⠀⢸⡿⠀⠀⠀⠀⠀⠀⠀⠀⠀⣠⣿⠀⠀⠀⣿⣧⣿⡿⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠈⣿⣧⢸⣿⡀⠀⡿⣧⠀⣿⡇⠀⠀⠀⠀⠀⠀⠀⠀⣿⡄⠀⠀⠀⣼⡇⠀⠀⠀⠀⠀⠀⢀⣤⣾⡟⢡⣶⠀⢠⣿⣿⣿⠃⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠹⣿⣿⣿⣷⠀⠇⢹⣷⡸⣿⣶⣦⣄⣀⡀⠀⠀⠀⣿⡇⠀⠀⢠⣿⠁⣀⣀⣠⣤⣶⣾⡿⢿⣿⡇⣼⣿⢀⣿⣿⠿⠏⠀⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠀⠈⠛⠛⣿⣷⣴⠀⢹⣿⣿⣿⡟⠿⠿⣿⣿⣿⣿⣾⣷⣶⣿⣿⣿⣿⡿⠿⠟⠛⠋⠉⠀⢸⣿⣿⣿⣿⣾⣿⠃⠀⠀⠀⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠈⢿⣿⣦⣘⣿⡿⣿⣿⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠘⠛⠛⠻⠿⠋⠁⠀⠀⠀⠀⠀⠀⠀⠀\n");
        printf("⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠙⠻⣿⣿⣿⠈⠉⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀⠀\n\n");
        printf("                       kawaiiiii~\n");
        printf("%s 1.0\n", basename((char *)argv[0]));
        printf("Copyright (C) 2025 愛子あゆみ\n");
        printf("License GPLv3+: GNU GPL version 3 or later <https://gnu.org/licenses/gpl.html>.\n");
        printf("This is free software: you are free to change and redistribute it.\n");
        printf("There is NO WARRANTY, to the extent permitted by law.\n\n");
        printf("Written by Ayumi Aiko\n");
        return 1;
    }
}